<h1 name="content" align="center"><a href=""> </a> MSSQL</h1>
<p align="center"> 
  <a href="#-lab1"><img alt="lab1" src="https://img.shields.io/badge/Lab1-blue"></a>
  <a href="#-lab2"><img alt="lab2" src="https://img.shields.io/badge/Lab2-blue"></a>
  <a href="#-lab3"><img alt="lab3" src="https://img.shields.io/badge/Lab3-blue"></a>
  <a href="#-lab4"><img alt="lab4" src="https://img.shields.io/badge/Lab4-blue"></a>
</p>
<h3 align="center"> <a href="#client"></a> 
  Вариант 15. Гостиница
  
  Список номеров: вместимость, комфортность, этаж, цена.
  Список клиентов: ФИО, паспорт, пол.
  Информация о сдаче номеров: дата заселения, срок поселения, фактическая дата освобождения, предварительная стоимость проживания.
  Информация о бронировании номеров: дата предполагаемого заселения, срок поселения, предварительная стоимость проживания.
  
  Реализовать:
  - Поиск свободных номеров по введенным критериям (Комфортность, дата заезда, срок поселения);
  - подсчет стоимости проживания при выезде клиента;
  - бронирование номера;
  - поиск постоянных клиентов (заселявшихся более 1 раза);
  - поиск клиентов с максимальным сроком проживания
</h3>

# <img src="https://github.com/user-attachments/assets/e080adec-6af7-4bd2-b232-d43cb37024ac" width="20" height="20"/> Lab1
[Назад](#content)
<h3 align="center">
  <a href="#client"></a>
</h3>

<div>
  <p><b>Задание:</b> разработать ER-модель данной предметной области: выделить сущности, их атрибуты, связи между сущностями.</p>

  <p><b>Для каждой сущности указать:</b></p>
  <ol type="1">
    <li>Имя сущности.</li>
    <li>Атрибут (или набор атрибутов), являющийся первичным ключом.</li>
    <li>Список остальных атрибутов.</li>
  </ol>

  <p><b>Для каждого атрибута указать:</b></p>
  <ol type="1">
    <li>Тип.</li>
    <li>Ограничения.</li>
    <li>Может ли он быть пустым.</li>
    <li>Является ли он первичным ключом.</li>
  </ol>

  <p><b>Для каждой связи между сущностями указать:</b></p>
  <ol type="1">
    <li>Тип связи (1:1, 1:M, M:N).</li>
    <li>Обязательность.</li>
  </ol>

  <p>ER-модель должна быть представлена в виде ER-диаграммы (картинка).</p>
  <p>По имеющейся ER-модели создать реляционную модель данных и отобразить её в виде списка сущностей с их атрибутами и типами атрибутов.  
  Для атрибутов указать, являются ли они первичными или внешними ключами.</p>


  <h4>№1. ER-модель</h4>
  <img src="/pictures/ER.png" alt="ER-модель"/>

  <h4>№1.1. Реляционная модель</h4>
  <img src="/pictures/REL.png" alt="Реляционная модель"/>
</div>

# <img src="https://github.com/user-attachments/assets/e080adec-6af7-4bd2-b232-d43cb37024ac" width="20" height="20"/> Lab2
[Назад](#content)
<h3 align="center">
  <a href="#client"></a>
</h3>

<div>
  <p><b>Задание:</b> в соответствии с реляционной моделью данных, разработанной в Лаб. №1, создать реляционную БД на учебном сервере БД.</p>

  <p><b>Необходимо:</b></p>
  <ol type="1">
    <li>Создать таблицы, определить первичные ключи и иные ограничения.</li>
    <li>Определить связи между таблицами.</li>
    <li>Создать диаграмму.</li>
    <li>Заполнить все таблицы адекватной информацией (не меньше 10 записей в каждой таблице, включая примеры для связей типа 1:M).</li>
  </ol>
</div>


## №2. Создание таблиц

```
CREATE TABLE Клиент (
    ID INT PRIMARY KEY IDENTITY,
    ФИО NVARCHAR(150) NOT NULL,
    Паспортные_данные CHAR(15) UNIQUE NOT NULL,
    Пол CHAR(1) CHECK (Пол IN ('М', 'Ж')) NOT NULL
);

CREATE TABLE Бронирование (
    ID INT PRIMARY KEY IDENTITY,
    Дата_создания DATE NOT NULL DEFAULT GETDATE(),
    Статус NVARCHAR(20) NOT NULL CHECK (Статус IN ('создана','отменена','завершена')),
    Дата_последнего_изменения DATETIME NOT NULL DEFAULT GETDATE(),
    Дата_предположительного_заселения DATE NOT NULL,
    Предварительная_стоимость DECIMAL(10,2) NOT NULL CHECK (Предварительная_стоимость > 0),
    Клиент_ID INT NOT NULL FOREIGN KEY REFERENCES Клиент(ID)
);

CREATE TABLE Номер (
    ID INT PRIMARY KEY IDENTITY,
    Вместимость INT NOT NULL CHECK (Вместимость > 0),
    Этаж INT NOT NULL,
    Комфортность NVARCHAR(15) NOT NULL,
    Цена_сутки DECIMAL(10,2) NOT NULL CHECK (Цена_сутки > 0)
);

CREATE TABLE Номер_Бронирование (
    Номер_ID INT NOT NULL FOREIGN KEY REFERENCES Номер(ID),
    Бронь_ID INT NOT NULL FOREIGN KEY REFERENCES Бронирование(ID),
    PRIMARY KEY (Номер_ID, Бронь_ID)
);

CREATE TABLE Заселение (
    ID INT PRIMARY KEY IDENTITY,
    Предварительная_стоимость DECIMAL(10,2) CHECK (Предварительная_стоимость > 0),
    Фактическая_дата_выезда DATE NULL,
    Итоговая_стоимость DECIMAL(10,2) CHECK (Итоговая_стоимость > 0),
    Дата_заселения DATE NULL,
    Клиент_ID INT NOT NULL FOREIGN KEY REFERENCES Клиент(ID)
);

CREATE TABLE Заселение_Номер (
    Заселение_ID INT NOT NULL FOREIGN KEY REFERENCES Заселение(ID),
    Номер_ID INT NOT NULL FOREIGN KEY REFERENCES Номер(ID),
    PRIMARY KEY (Заселение_ID, Номер_ID)
);

CREATE TABLE Услуга (
    ID INT PRIMARY KEY IDENTITY,
    Название NVARCHAR(50) NOT NULL,
    Цена DECIMAL(10,2) NOT NULL CHECK (Цена >= 0)
);

CREATE TABLE Заселение_Услуга (
    Заселение_ID INT NOT NULL FOREIGN KEY REFERENCES Заселение(ID),
    Услуга_ID INT NOT NULL FOREIGN KEY REFERENCES Услуга(ID),
    PRIMARY KEY (Заселение_ID, Услуга_ID)
);

CREATE TABLE Оплата (
    ID INT PRIMARY KEY IDENTITY,
    Дата_оплаты DATE NOT NULL,
    Сумма DECIMAL(10,2) NOT NULL CHECK (Сумма > 0),
    Способ_оплаты NVARCHAR(30) NOT NULL,
    Заселение_ID INT NOT NULL FOREIGN KEY REFERENCES Заселение(ID)
);

INSERT INTO Клиент (ФИО, Паспортные_данные, Пол) VALUES
('Шипицын Денис Александрович','1118000001', 'М'),
('Немтинов Никита Сергеевич','1118000002', 'М'),
('Сидорова Анна Павловна','1118000003', 'Ж'),
('Кузнецов Алексей Николаевич','1118000004', 'М'),
('Соколова Мария Сергеевна','1118000005', 'Ж'),
('Морозов Дмитрий Викторович','1118000006', 'М'),
('Васильева Елена Андреевна','1118000007', 'Ж'),
('Попов Николай Егорович','1118000008', 'М'),
('Козлова Татьяна Игоревна','1118000009', 'Ж'),
('Орлов Артём Константинович','1118000011', 'М'),
('Федорова Валентина Петровна','1118000012', 'Ж'),
('Новиков Сергей Александрович','1118000013', 'М'), --12
('Сергиевский Никита Романович','1118000014', 'М'), --13
('Минина Анна Евгеньевна','1118000015', 'Ж'), --14
('Сладкая Елена Викторовна','1118000016', 'Ж'); --15

INSERT INTO Номер (Вместимость, Этаж, Комфортность, Цена_сутки) VALUES
(1, 1, 'Стандарт', 1500.00), --1 +
(2, 1, 'Стандарт', 2000.00), --2 +
(2, 2, 'Комфорт', 2800.00), --3 +
(3, 2, 'Комфорт', 3200.00), --4 +
(1, 3, 'Люкс', 5000.00), --5 +
(2, 3, 'Люкс', 6500.00), --6 +
(4, 4, 'Апартаменты', 9000.00), --7 +
(1, 4, 'Стандарт', 1700.00), --8
(2, 5, 'Комфорт', 3000.00), --9 +
(3, 5, 'Люкс', 7000.00), --10 +
(2, 6, 'Комфорт+', 4500.00), --11 +
(2, 5, 'Комфорт', 3000.00), --12 +
(4, 7, 'Апартаменты', 12000.00), --13
(1, 7, 'Апартаменты', 10000.00), --14 +
(4, 6, 'Комфорт+', 5500.00), --15
(2, 6, 'Комфорт+', 4500.00); --16

INSERT INTO Бронирование (Статус, Дата_предположительного_заселения, Предварительная_стоимость, клиент_id) VALUES
('завершена', '2025-09-20', 1500.00 * 2, 1), --1
('создана', '2025-09-26', 7000.00 * 1, 2), --2
('завершена', '2025-09-10', 5000.00 * 5, 3), --3
('отменена', '2025-09-27', 3000.00 * 1, 4), --4
('создана', '2025-09-24', 4500.00 * 2, 5), --5
('завершена', '2025-08-01', 2000.00 * 10, 6), --6
('завершена', '2025-08-05', 3200.00 * 1, 7), --7
('завершена', '2025-09-15', 3000.00 * 7, 8), --8
('создана', '2025-09-20', 9000.00 * 10, 9), --9
('завершена', '2025-09-02', 6500.00 * 2, 10), --10
('завершена', '2025-09-19', 2800.00 * 1, 11), --11
('завершена', '2025-10-01', 10000.00 * 4, 12), --12
('завершена', '2025-10-10', 4500.00 * 1, 15), --13
('завершена', '2025-10-12', 2000.00 * 4, 6), --14
('завершена', '2025-10-12', 5000.00 * 2, 3); --15

INSERT INTO Номер_Бронирование (номер_id, бронь_id) VALUES
(1,1),
(10,2),
(5,3),
(12,4),
(11,5),
(2,6),
(4,7),
(9,8),
(7,9),
(6,10),
(3,11),
(14,12),
(16,13),
(2, 14),
(5,15);

INSERT INTO Заселение (Предварительная_стоимость, Фактическая_дата_выезда, Итоговая_стоимость, Дата_заселения, клиент_id) VALUES
(3000.00, '2025-09-22', 3000.00, '2025-09-20', 1), --1
(7000.00, NULL, NULL, NULL, 2), --2
(25000.00, '2025-09-15', 25000.00, '2025-09-10', 3), --3
(9000.00, NULL, NULL, '2025-09-24', 5), --4
(20000.00, '2025-08-11', 20000.00, '2025-08-01', 6), --5
(3200.00, '2025-08-06', 3200.00, '2025-08-05', 7), --6
(21000.00, '2025-09-22', 21000.00, '2025-09-15', 8), --7
(90000.00, NULL, NULL, '2025-09-20', 9), --8
(13000.00, '2025-09-04', 13000.00, '2025-09-02', 10), --9
(2800.00, '2025-09-20', 2800.00, '2025-09-19', 11), --10
(40000.00, '2025-10-04', 30000.00, '2025-10-01', 12), --11
(8000.00, '2025-10-16', 8000.00, '2025-10-12', 6), --12
(10000.00, '2025-10-14', 10000.00, '2025-10-12', 3); --13

INSERT INTO Заселение_Номер (заселение_id, номер_id) VALUES
(1,1),
(2,10),
(3,5),
(4,11),
(5,2),
(6,4),
(7,9),
(8,7),
(9,6),
(10,3),
(11,14),
(12,2),
(13,5);

INSERT INTO Услуга (Название, Цена) VALUES
('Завтрак', 500.00), --1
('Ужин', 1000.00), --2
('Трансфер', 1500.00), --3
('Сауна', 2000.00), --4
('Бассейн', 1200.00), --5
('Парковка', 700.00), --6
('Wi-Fi', 300.00), --7
('Мини-бар', 800.00), --8
('Спортзал', 1100.00), --9
('Прачечная', 900.00); --10

-- заказанное
INSERT INTO Заселение_Услуга (заселение_id, услуга_id) VALUES
(1,1),
(1,2),
(2,9),
(3,8),
(3,4),
(4,2),
(5,1),
(5,2),
(5,3),
(7,8),
(7,4),
(9,1);

-- оплаты: завершенные оплачены полностью в последний день, у текущих оплата без услуг в любой день
INSERT INTO Оплата (Дата_оплаты, Сумма, Способ_оплаты, заселение_id) VALUES
('2025-09-22', 4500.00, 'Карта', 1),
('2025-09-24', 8100.00, 'Карта', 2),
('2025-09-15', 27800.00, 'Наличные', 3),
('2025-09-24', 9000.00, 'Карта',4),
('2025-08-11', 23000.00, 'Карта', 5),
('2025-08-06', 3200.00, 'Карта', 6),
('2025-09-22', 23800.00, 'Карта', 7),
('2025-09-20', 90000.00, 'Карта', 8),
('2025-09-04', 13500.00, 'Карта', 9),
('2025-09-20', 2800.00, 'Карта', 10),
('2025-10-04', 30000.00, 'Карта', 11),
('2025-10-16', 8000.00, 'Наличные', 12),
('2025-10-14', 10000.00, 'Карта', 13);

--SELECT * FROM Клиент
--SELECT * FROM Номер
--SELECT * FROM Бронирование
--SELECT * FROM Номер_Бронирование
--SELECT * FROM Заселение
--SELECT * FROM Заселение_Номер
--SELECT * FROM Услуга
--SELECT * FROM Заселение_Услуга
--SELECT * FROM Оплата
```

## №2.1. Диаграмма
![image](/pictures/diagram.png)

## №2.2. Заполненные таблицы
### Клиент
![image](/pictures/1.png)
### Номер
![image](/pictures/2.png)
### Бронирование
![image](/pictures/3.png)
### Номер_Бронирование
![image](/pictures/4.png)
### Заселение
![image](/pictures/5.png)
### Заселение_Номер
![image](/pictures/6.png)
### Услуга
![image](/pictures/7.png)
### Заселение_Услуга
![image](/pictures/8.png)
### Оплата
![image](/pictures/9.png)

# <img src="https://github.com/user-attachments/assets/e080adec-6af7-4bd2-b232-d43cb37024ac" width="20" height="20"/> Lab3
[Назад](#content)
<h3 align="center">
  <a href="#client"></a>
</h3>

<div>
  <h4>Часть 1</h4>
  <p><b>Цель:</b> изучить конструкции языка SQL для манипулирования данными в СУБД MSSQL.</p>
  <p><b>Задания и краткое описание работы:</b></p>
  <ol>
    <li>Выборка из одной таблицы.
      <ol type="1">
        <li>Выбрать из произвольной таблицы данные и отсортировать их по двум произвольным имеющимся в таблице признакам (разные направления сортировки).</li>
        <li>Выбрать из произвольной таблицы те записи, которые удовлетворяют условию отбора (where). Привести 2-3 запроса.</li>
        <li>Привести примеры 2-3 запросов с использованием агрегатных функций (count, max, sum и др.) с группировкой и без группировки.</li>
        <li>Привести примеры подведения подытога с использованием GROUP BY [ALL] [CUBE | ROLLUP] (2-3 запроса). В ROLLUP и CUBE использовать не менее 2-х столбцов.</li>
        <li>Выбрать из таблиц информацию об объектах, в названиях которых нет заданной последовательности букв (LIKE).</li>
      </ol>
    </li>
    <li>Выборка из нескольких таблиц.
      <ol type="1">
        <li>Вывести информацию подчиненной (дочерней) таблицы, заменяя коды (значения внешних ключей) соответствующими символьными значениями из родительских таблиц. Привести 2-3 запроса с использованием классического подхода соединения таблиц (where).</li>
        <li>Реализовать запросы пункта 2.1 через внутреннее соединение inner join.</li>
        <li>Левое внешнее соединение left join. Привести 2-3 запроса.</li>
        <li>Правое внешнее соединение right join. Привести 2-3 запроса.</li>
        <li>Привести примеры 2-3 запросов с использованием агрегатных функций и группировки.</li>
        <li>Привести примеры 2-3 запросов с использованием группировки и условия отбора групп (Having).</li>
        <li>Привести примеры 3-4 вложенных (соотнесенных, с использованием IN, EXISTS) запросов.</li>
      </ol>
    </li>
    <li>Представления
      <ol type="1">
        <li>На основе любых запросов из п. 2 создать два представления (VIEW).</li>
        <li>Привести примеры использования общетабличных выражений (CTE) (2-3 запроса).</li>
      </ol>
    </li>
    <li>Функции ранжирования
      <ol type="1">
        <li>Привести примеры 3-4 запросов с использованием ROW_NUMBER, RANK, DENSE_RANK (с PARTITION BY и без).</li>
      </ol>
    </li>
    <li>Объединение, пересечение, разность
      <ol type="1">
        <li>Привести примеры 3-4 запросов с использованием UNION / UNION ALL, EXCEPT, INTERSECT. Данные в одном из запросов отсортируйте по произвольному признаку.</li>
      </ol>
    </li>
    <li>Использование CASE, PIVOT и UNPIVOT
      <ol type="1">
        <li>Привести примеры получения сводных (итоговых) таблиц с использованием CASE.</li>
        <li>Привести примеры получения сводных (итоговых) таблиц с использованием PIVOT и UNPIVOT.</li>
      </ol>
    </li>
  </ol>

  <p><b>Обязательными к выполнению</b> являются запросы, приведенные ниже (смотри свой вариант).</p>
  <p>Отчет по лабораторной работе предоставляется в виде документа <i>(Фамилия_Группа.docx)</i>.  
  В этом документе по каждому заданию необходимо представить: условие запроса, текст SQL-запроса, скрин-копию результата выполнения запроса.</p>

  <h4>Часть 2</h4>
  <p><b>Составить следующие запросы:</b></p>
  <ol type="a">
    <li>Найти номера, не занятые и не забронированные на данный момент.</li>
    <li>Найти клиентов, выехавших из номера раньше срока, указанного в договоре.</li>
    <li>Найти номера, которые ни разу не сдавались с начала текущего года.</li>
    <li>Найти клиентов, забронировавших номер, но так и не въехавших в него.</li>
    <li>Среди всех клиентов, наиболее часто пользующихся услугами гостиницы, найти клиентов с максимальным сроком проживания.</li>
  </ol>
</div>
<a href="https://github.com/shidendi/databases_Shipitsyn_PMI-32_15variant/raw/main/Doc/Шипицын_ПМИ-32БО.docx" target="_blank">Лабораторная №3</a>


# <img src="https://github.com/user-attachments/assets/e080adec-6af7-4bd2-b232-d43cb37024ac" width="20" height="20"/> Lab4
[Назад](#content)
<h3 align="center">
  <a href="#client"></a>
</h3>

<div>
  <h4>Создать  4 различных хранимых процедуры:</h4>
  <ol type="a">
    <li><b>Процедура без параметров, формирующая список номеров (номер, комфортность, цена), которые никогда не бронировались и не заселялись.</li>
  <pre><code>
CREATE PROCEDURE dbo.Номера_НеИспользовались
AS
BEGIN
    -- хранение рез-ов
    DECLARE @Номер_ID INT, 
            @Комфортность NVARCHAR(15), 
            @Цена_сутки DECIMAL(10,2);
    -- куроср по номерам без брони и заселения
    DECLARE номера_cursor CURSOR FOR
        SELECT n.ID, n.Комфортность, n.Цена_сутки
        FROM Номер n
        WHERE n.ID NOT IN (SELECT Номер_ID FROM Номер_Бронирование)
          AND n.ID NOT IN (SELECT Номер_ID FROM Заселение_Номер);
    -- открыть курсор
    OPEN номера_cursor;
    -- первая запись
    FETCH NEXT FROM номера_cursor INTO @Номер_ID, @Комфортность, @Цена_сутки;
    PRINT 'Список номеров, которые никогда не бронировались и не заселялись:';
    -- циклом по всем строкам из выборки
    WHILE @@FETCH_STATUS = 0
    BEGIN
        PRINT 'Номер ID: ' + CAST(@Номер_ID AS NVARCHAR(10)) +
              ', Комфортность: ' + @Комфортность +
              ', Цена за сутки: ' + CAST(@Цена_сутки AS NVARCHAR(20));
        FETCH NEXT FROM номера_cursor INTO @Номер_ID, @Комфортность, @Цена_сутки;
    END
    -- курсор закрыть и освободить
    CLOSE номера_cursor;
    DEALLOCATE номера_cursor;
END;
GO

EXEC dbo.Номера_НеИспользовались;
  </code></pre>
    <li><b> Процедура, на входе получающая критерии поиска номера (комфортность, дата заезда, срок поселения) и формирующая список подходящих номеров с учетом того, что они на этот срок не должны быть заняты или забронированы.</li>
    <li><b> Процедура, на входе получающая ФИО клиента, выходной параметр – дата его последнего заселения.</li>
    <li><b> Процедура, вызывающая вложенную процедуру, которая подсчитывает среднюю посещаемость клиентами нашей гостиницы (т.е., сколько раз в среднем каждый клиент пользовался нашими услугами). Главная процедура выводит список клиентов, число посещений которых больше среднего.</li>
  </ol>

  <h4>3 пользовательские функции:</h4>
  <ol type="a">
    <li><b>Скалярная функция, возвращающая ФИО клиента, прожившего в гостинице наибольшее количество дней в сумме за все посещения. Если их несколько, возвращается клиент с наименьшим ID.</li>
  <pre><code>
CREATE FUNCTION dbo.Клиент_МаксимальноеПроживание()
RETURNS NVARCHAR(150)
AS
BEGIN
    DECLARE @ФИО NVARCHAR(150);
    ;WITH Проживания AS (
        SELECT 
            z.Клиент_ID,
            SUM(DATEDIFF(DAY, z.Дата_заселения, z.Фактическая_дата_выезда)) AS Всего_дней
        FROM Заселение z
        WHERE z.Дата_заселения IS NOT NULL
          AND z.Фактическая_дата_выезда IS NOT NULL
        GROUP BY z.Клиент_ID
    ),
    МаксПроживание AS (
        SELECT MAX(Всего_дней) AS Макс_дней
        FROM Проживания
    )
    SELECT TOP 1 @ФИО = k.ФИО
    FROM Проживания p
    JOIN МаксПроживание m ON p.Всего_дней = m.Макс_дней
    JOIN Клиент k ON k.ID = p.Клиент_ID
    ORDER BY k.ID;
    RETURN @ФИО;
END;
GO
  </code></pre>
<img src="pictures/4.2.1.png" alt="Схема 4.2.1" width="250">
    <li><b>Inline-функция, возвращающая список номеров, забронированных на данный момент, но реально не занятых (клиенты нас «обманули»).</li>
    <li><b>Multi-statement-функция, возвращающая список забронированных номеров, в которые клиенты так и не въехали за весь период брони.</li>
  </ol>

  <h4>Создать  3 триггера:</h4>
  <ol type="a">
    <li><b>Триггер любого типа на добавление брони – если дата заезда больше текущей на 6 месяцев – цена на такую бронь увеличивается на 10%.</li>
    <li><b>Последующий триггер на изменение фактической даты освобождения – если клиент прожил в гостинице больше, чем было записано в договоре, пересчитать общую стоимость проживания.</li> 
    <li><b>Замещающий триггер на операцию удаления номера из списка номеров – если номер на данный момент занят, то не удаляем его, выводим сообщение о невозможности удаления; если не занят – удаляем его и всю информацию о его сдаче и бронировании</li>
  </ol>

  <p><b>Обязательно предусмотреть обработку НЕСКОЛЬКИХ записей! (там, где необходимо, использовать КУРСОР!)</b>.</p>

</div>

